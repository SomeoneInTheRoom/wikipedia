<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WikiScroll</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: #f7f7f8; }
    .wrap { max-width: 760px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 6px; }
    .sub { color: #555; margin: 0 0 18px; }
    .toolbar { display: flex; gap: 8px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ddd; background: white; cursor: pointer; }
    button:disabled { opacity: .6; cursor: default; }
    .filters { display: flex; gap: 8px; flex-wrap: wrap; }
    .pill { padding: 6px 10px; border-radius: 999px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    .pill.active { border-color: #000; }
    .feed { display: grid; gap: 16px; }
    .card { background: #fff; border: 1px solid #e6e6e6; border-radius: 14px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,.04); }
    .card img { width: 100%; height: 240px; object-fit: cover; display: block; }
    .content { padding: 14px 16px 16px; }
    .title { font-weight: 600; margin: 0 0 8px; }
    .extract { color: #333; line-height: 1.45; margin: 0 0 10px; }
    .link { color: #2563eb; text-decoration: none; }
    .actions { display: flex; gap: 8px; margin-top: 10px; }
    .actions button { font-size: 13px; padding: 6px 10px; }
    .footer { text-align: center; color: #777; font-size: 12px; margin-top: 22px; }
    /* toast */
    .toast { position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%); background: rgba(0,0,0,.85);
             color: #fff; padding: 10px 14px; border-radius: 10px; font-size: 14px; opacity: 0; pointer-events: none; transition: opacity .25s; }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>WikiScroll</h1>
    <p class="sub">A fun, scrollable stream of science & history from Wikipedia.</p>

    <div class="toolbar">
      <button id="moreBtn">Get another article</button>
      <div class="filters" id="filters"></div>
    </div>

    <div class="feed" id="feed"></div>
    <p class="footer">Content from Wikipedia via the MediaWiki APIs. Sports content filtered out.</p>
  </div>

  <div id="toast" class="toast">Copied!</div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // ------- DOM refs -------
    const feed    = document.getElementById("feed");
    const moreBtn = document.getElementById("moreBtn");
    const filters = document.getElementById("filters");

    // ------- state -------
    const TOPICS = ["All","Physics","Math","Biology","Chemistry","Astronomy","History","Philosophy","Engineering"];
    let activeTopic = "All";
    const seenIds = new Set(); // pageid/id to avoid duplicates

    // ------- build filter pills -------
    filters.innerHTML = "";
    TOPICS.forEach(t => {
      const b = document.createElement("button");
      b.className = "pill" + (t===activeTopic ? " active":"");
      b.textContent = t;
      b.onclick = () => {
        activeTopic = t;
        [...filters.children].forEach(x => x.classList.remove("active"));
        b.classList.add("active");
      };
      filters.appendChild(b);
    });

    // ------- helpers -------
    const SPORTS = ["football","soccer","basketball","baseball","cricket","hockey","rugby","tennis","olympics","athlete","tournament","coach"];
    const isSportsLike = (s="") => SPORTS.some(k => s.toLowerCase().includes(k));

    const fetchJSON = async (url) => {
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
      return r.json();
    };

    // Get many pages at once from a category (with extract, thumbnail, url)
    async function fetchCategoryBatch(catTitle, batch=40) {
      const url = new URL("https://en.wikipedia.org/w/api.php");
      url.searchParams.set("origin","*");
      url.searchParams.set("format","json");
      url.searchParams.set("action","query");
      url.searchParams.set("generator","categorymembers");
      url.searchParams.set("gcmtitle", catTitle);
      url.searchParams.set("gcmtype","page");
      url.searchParams.set("gcmlimit", String(Math.min(batch, 50)));
      url.searchParams.set("prop","extracts|pageimages|info");
      url.searchParams.set("exintro","1"); url.searchParams.set("explaintext","1");
      url.searchParams.set("pithumbsize","800"); url.searchParams.set("inprop","url");

      const data = await fetchJSON(url);
      const pages = data?.query?.pages ? Object.values(data.query.pages) : [];
      for (let i = pages.length - 1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [pages[i],pages[j]]=[pages[j],pages[i]]; }
      return pages;
    }

    // Random summaries (for "All")
    async function fetchRandomBatch(batch=18) {
      const tasks = Array.from({length:batch}, () =>
        fetch("https://en.wikipedia.org/api/rest_v1/page/random/summary", { cache:"no-store" })
          .then(r => r.ok ? r.json() : null).catch(()=>null)
      );
      return (await Promise.all(tasks)).filter(Boolean);
    }

    function pickFirstAcceptable(items) {
      for (const a of items) {
        const id = a.pageid ?? a.id ?? null;
        const text = `${a.title||""} ${a.description||""} ${a.extract||""}`;
        if (!id) continue;
        if (seenIds.has(id)) continue;
        if (!a.extract || a.extract.length < 40) continue; // avoid stubs
        if (isSportsLike(text)) continue;
        return a;
      }
      return null;
    }

    function showToast(msg="Copied!") {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 1200);
    }

    function buildChatPrompt(article, topicLabel) {
      const url = article.fullurl || (article.content_urls?.desktop?.page ?? "");
      const title = article.title || "this topic";
      const summary = (article.extract || "").slice(0, 600);
      const topic = (topicLabel && topicLabel !== "All") ? ` (${topicLabel})` : "";
      return [
        `Explain **${title}**${topic} accurately and concisely.`,
        `Base your answer on this Wikipedia article: ${url}`,
        ``,
        `Constraints:`,
        `- 3–4 sentence overview with definitions.`,
        `- 5 key facts/mechanisms, clearly separated.`,
        `- Why it matters (scientific or historical context).`,
        `- Equations if relevant, each with a one-line interpretation.`,
        `- 2–3 common misconceptions to avoid.`,
        `- Finish with 3 comprehension checks and 5 flashcards (Q → A).`,
        ``,
        `Wikipedia summary for reference:`,
        summary
      ].join("\\n");
    }

    function renderCard(a) {
      seenIds.add(a.pageid ?? a.id);
      const card = document.createElement("div");
      card.className = "card";

      if (a.thumbnail?.source) {
        const img = document.createElement("img");
        img.src = a.thumbnail.source;
        img.alt = a.title;
        card.appendChild(img);
      }

      const c = document.createElement("div"); c.className = "content";
      const h = document.createElement("h2"); h.className = "title"; h.textContent = a.title; c.appendChild(h);
      const p = document.createElement("p"); p.className = "extract"; p.textContent = a.extract || ""; c.appendChild(p);

      const link = document.createElement("a");
      link.className = "link";
      link.href = a.fullurl || a.content_urls?.desktop?.page || "#";
      link.target = "_blank"; link.rel = "noopener";
      link.textContent = "Read on Wikipedia →";
      c.appendChild(link);

      const actions = document.createElement("div");
      actions.className = "actions";
      const copyBtn = document.createElement("button");
      copyBtn.textContent = "Copy chat prompt";
      copyBtn.onclick = async () => {
        const prompt = buildChatPrompt(a, activeTopic);
        try { await navigator.clipboard.writeText(prompt); showToast("Chat prompt copied"); }
        catch { window.prompt("Copy this prompt:", prompt); }
      };
      actions.appendChild(copyBtn);
      c.appendChild(actions);

      card.appendChild(c);

      card.addEventListener("contextmenu", async (ev) => {
        ev.preventDefault();
        const prompt = buildChatPrompt(a, activeTopic);
        try { await navigator.clipboard.writeText(prompt); showToast("Chat prompt copied"); }
        catch { window.prompt("Copy this prompt:", prompt); }
      });

      feed.insertBefore(card, feed.firstChild);
    }

    const mainCategoryFor = (topic) => ({
      Physics:    "Category:Physics",
      Math:       "Category:Mathematics",
      Biology:    "Category:Biology",
      Chemistry:  "Category:Chemistry",
      Astronomy:  "Category:Astronomy",
      History:    "Category:History",
      Philosophy: "Category:Philosophy",
      Engineering:"Category:Engineering"
    }[topic]);

    const fallbackCategoryFor = (topic) => ({
      Physics: "Category:Physical_sciences",
      Math: "Category:Mathematical_concepts",
      Biology: "Category:Biological_concepts",
      Chemistry: "Category:Chemical_compounds",
      Astronomy: "Category:Astrophysics",
      History: "Category:Historical_events",
      Philosophy: "Category:Ethics",
      Engineering: "Category:Mechanical_engineering"
    }[topic]);

    async function getOneArticle(topic) {
      if (topic === "All") {
        const batch = await fetchRandomBatch(18);
        return pickFirstAcceptable(batch);
      }
      const cat = mainCategoryFor(topic);
      let pages = cat ? await fetchCategoryBatch(cat, 40) : [];
      let pick  = pickFirstAcceptable(pages);
      if (pick) return pick;

      const sub = fallbackCategoryFor(topic);
      if (sub) {
        pages = await fetchCategoryBatch(sub, 40);
        pick  = pickFirstAcceptable(pages);
      }
      return pick;
    }

    async function fetchAndShow() {
      moreBtn.disabled = true; moreBtn.textContent = "Loading...";
      try {
        const a = await getOneArticle(activeTopic);
        if (a) renderCard(a);
        else {
          const note = document.createElement("div");
          note.className = "card";
          note.innerHTML = `<div class="content"><p class="extract">Couldn’t find a fresh “${activeTopic}” article right now. Try again.</p></div>`;
          feed.insertBefore(note, feed.firstChild);
        }
      } catch (e) {
        console.error(e);
        const note = document.createElement("div");
        note.className = "card";
        note.innerHTML = `<div class="content"><p class="extract">Network hiccup. Reload the page or try again.</p></div>`;
        feed.insertBefore(note, feed.firstChild);
      } finally {
        moreBtn.disabled = false; moreBtn.textContent = "Get another article";
      }
    }

    moreBtn.addEventListener("click", fetchAndShow);
    fetchAndShow(); // initial

    // gentle infinite scroll
    let ticking = false;
    window.addEventListener("scroll", () => {
      if (ticking) return; ticking = true;
      requestAnimationFrame(() => {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 250) fetchAndShow();
        ticking = false;
      });
    });
  });
  </script>
</body>
</html>
