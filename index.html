<script>
  // --- simple topic filter tags ---
  const TOPICS = ["All","Physics","Math","Biology","Chemistry","Astronomy","History","Philosophy","Engineering"];
  let activeTopic = "All";
  const filtersEl = document.getElementById("filters") || (() => {
    const d = document.createElement("div"); d.id="filters"; d.className="filters"; 
    document.querySelector(".toolbar").appendChild(d); return d; })();

  // build pills
  TOPICS.forEach(t => {
    const b = document.createElement("button");
    b.className = "pill" + (t === activeTopic ? " active" : "");
    b.textContent = t;
    b.onclick = () => {
      activeTopic = t;
      [...filtersEl.children].forEach(x => x.classList.remove("active"));
      b.classList.add("active");
    };
    filtersEl.appendChild(b);
  });

  const feed   = document.getElementById("feed");
  const moreBtn= document.getElementById("moreBtn");
  let loading  = false;
  const seen   = new Set(); // avoid repeats by title

  // --- helpers ---
  function isSportsLike(text="") {
    const s = text.toLowerCase();
    return ["football","soccer","basketball","baseball","cricket","hockey",
            "rugby","tennis","olympics","athlete","coach","tournament"].some(k => s.includes(k));
  }

  function matchesTopic(article, topic) {
    if (topic === "All") return true;
    const t = (article.description || "") + " " + (article.extract || "") + " " + (article.title || "");
    const s = t.toLowerCase();
    const map = {
      physics:     ["physics","quantum","relativity","particle","thermodynamics","optics","mechanics","cosmology","astrophysics","wave"],
      math:        ["mathematics","mathematician","algebra","calculus","geometry","topology","number theory","probability","statistics"],
      biology:     ["biology","biologist","evolution","genetics","cell","ecology","organism","neuroscience","biochemistry"],
      chemistry:   ["chemistry","chemist","molecule","reaction","organic","inorganic","analytical","stoichiometry","spectroscopy"],
      astronomy:   ["astronomy","astronomer","galaxy","star","planet","nebula","supernova","telescope","exoplanet"],
      history:     ["history","ancient","medieval","empire","revolution","war","dynasty","archaeology","historian","treaty"],
      philosophy:  ["philosophy","philosopher","ethics","metaphysics","epistemology","logic","stoicism","phenomenology"],
      engineering: ["engineering","engineer","mechanical","electrical","civil","aerospace","software","materials","control"]
    };
    return (map[topic.toLowerCase()] || []).some(k => s.includes(k));
  }

  async function getRandomSummary() {
    const r = await fetch("https://en.wikipedia.org/api/rest_v1/page/random/summary", { cache: "no-store" });
    if (!r.ok) throw new Error("HTTP " + r.status);
    return r.json();
  }

  // Fetch N in parallel, filter, return first usable one (or null)
  async function fetchBatchFiltered(batchSize = 10) {
    // parallel requests
    const promises = Array.from({ length: batchSize }, () => getRandomSummary().catch(() => null));
    const results  = (await Promise.all(promises)).filter(Boolean);

    // filter out sports, duplicates, and off-topic
    const filtered = results.filter(a => {
      if (!a || !a.title) return false;
      const blob = `${a.title} ${a.description || ""} ${a.extract || ""}`;
      if (isSportsLike(blob)) return false;
      if (!matchesTopic(a, activeTopic)) return false;
      if (seen.has(a.title)) return false;
      return true;
    });

    return filtered.length ? filtered[0] : null;
  }

  function addCard(article) {
    seen.add(article.title);
    const card = document.createElement("div");
    card.className = "card";

    if (article.thumbnail?.source) {
      const img = document.createElement("img");
      img.src = article.thumbnail.source;
      img.alt = article.title;
      card.appendChild(img);
    }

    const c = document.createElement("div");
    c.className = "content";
    const h = document.createElement("h2"); h.className = "title"; h.textContent = article.title; c.appendChild(h);
    const p = document.createElement("p"); p.className = "extract"; p.textContent = article.extract || ""; c.appendChild(p);
    const a = document.createElement("a"); a.className = "link";
    a.href = article.content_urls?.desktop?.page || "#"; a.target = "_blank"; a.rel="noopener";
    a.textContent = "Read on Wikipedia →";
    c.appendChild(a);

    card.appendChild(c);
    feed.insertBefore(card, feed.firstChild);
  }

  async function fetchArticle() {
    if (loading) return;
    loading = true;
    moreBtn.disabled = true; moreBtn.textContent = "Loading...";

    try {
      // Try a bigger batch first; if none, widen search once
      let pick = await fetchBatchFiltered(12);
      if (!pick && activeTopic !== "All") {
        // fallback: try again with a larger batch before giving up
        pick = await fetchBatchFiltered(20);
      }

      if (pick) {
        addCard(pick);
      } else {
        // user feedback, but keep things snappy
        const note = document.createElement("div");
        note.className = "card";
        note.innerHTML = `<div class="content"><p class="extract">No fresh articles matched “${activeTopic}”. Try again or switch topics.</p></div>`;
        feed.insertBefore(note, feed.firstChild);
      }
    } catch (e) {
      console.error(e);
      alert("Could not fetch articles right now. Please try again.");
    } finally {
      loading = false;
      moreBtn.disabled = false; moreBtn.textContent = "Get another article";
    }
  }

  // wire up UI
  moreBtn.addEventListener("click", fetchArticle);
  fetchArticle(); // initial
  // gentle infinite scroll
  let ticking = false;
  window.addEventListener("scroll", () => {
    if (ticking) return;
    ticking = true;
    requestAnimationFrame(() => {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 250) fetchArticle();
      ticking = false;
    });
  });
</script>
