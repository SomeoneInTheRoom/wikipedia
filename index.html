<script>
  // ------- basic UI state -------
  const TOPICS = ["All","Physics","Math","Biology","Chemistry","Astronomy","History","Philosophy","Engineering"];
  let activeTopic = "All";
  const feed    = document.getElementById("feed");
  const moreBtn = document.getElementById("moreBtn");
  const filters = document.getElementById("filters");
  const seenIds = new Set(); // use pageid, not title

  // Build pills
  TOPICS.forEach(t => {
    const b = document.createElement("button");
    b.className = "pill" + (t===activeTopic ? " active":"");
    b.textContent = t;
    b.onclick = () => {
      activeTopic = t;
      [...filters.children].forEach(x => x.classList.remove("active"));
      b.classList.add("active");
    };
    filters.appendChild(b);
  });

  // ------- helpers -------
  const SPORTS = ["football","soccer","basketball","baseball","cricket","hockey","rugby","tennis","olympics","athlete","tournament","coach"];
  function isSportsLike(s=""){ s=s.toLowerCase(); return SPORTS.some(k=>s.includes(k)); }

  // Action API (returns many pages at once)
  async function fetchCategoryBatch(catTitle, batch=40) {
    // generator=categorymembers returns pages + lets us request extracts & thumbnails in the same response
    const url = new URL("https://en.wikipedia.org/w/api.php");
    url.searchParams.set("origin","*"); // CORS
    url.searchParams.set("format","json");
    url.searchParams.set("action","query");
    url.searchParams.set("generator","categorymembers");
    url.searchParams.set("gcmtitle", catTitle);         // e.g., Category:Physics
    url.searchParams.set("gcmtype","page");
    url.searchParams.set("gcmlimit", String(Math.min(batch, 50))); // API cap for anon is ~50
    url.searchParams.set("prop","extracts|pageimages|info");
    url.searchParams.set("exintro","1");    // only lead section
    url.searchParams.set("explaintext","1");// plain text
    url.searchParams.set("inprop","url");   // fullurl
    url.searchParams.set("pithumbsize","800");

    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) throw new Error("HTTP " + r.status);
    const data = await r.json();
    const pages = data?.query?.pages ? Object.values(data.query.pages) : [];
    // shuffle so we don’t always hit the same few
    for (let i = pages.length - 1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [pages[i],pages[j]]=[pages[j],pages[i]]; }
    return pages;
  }

  async function fetchRandomBatch(batch=20) {
    // true random summaries (parallel)
    const tasks = Array.from({length:batch}, () =>
      fetch("https://en.wikipedia.org/api/rest_v1/page/random/summary", { cache:"no-store" })
        .then(r => r.ok ? r.json() : null)
        .catch(()=>null)
    );
    return (await Promise.all(tasks)).filter(Boolean);
  }

  function pickFirstAcceptable(items) {
    for (const a of items) {
      const id   = a.pageid ?? a.id ?? null;
      const text = `${a.title||""} ${a.description||""} ${a.extract||""}`;
      if (!id) continue;
      if (seenIds.has(id)) continue;
      if (!a.extract || a.extract.length < 40) continue; // avoid stubs
      if (isSportsLike(text)) continue;
      return a;
    }
    return null;
  }

  function renderCard(a) {
    seenIds.add(a.pageid ?? a.id);
    const card = document.createElement("div");
    card.className = "card";
    if (a.thumbnail?.source) {
      const img = document.createElement("img");
      img.src = a.thumbnail.source;
      img.alt = a.title;
      card.appendChild(img);
    }
    const c = document.createElement("div"); c.className = "content";
    const h = document.createElement("h2"); h.className = "title"; h.textContent = a.title; c.appendChild(h);
    const p = document.createElement("p"); p.className = "extract"; p.textContent = a.extract || ""; c.appendChild(p);
    const link = document.createElement("a");
    link.className = "link";
    link.href = a.fullurl || a.content_urls?.desktop?.page || "#";
    link.target = "_blank"; link.rel = "noopener";
    link.textContent = "Read on Wikipedia →";
    c.appendChild(link);
    card.appendChild(c);
    feed.insertBefore(card, feed.firstChild);
  }

  async function getOneArticle() {
    if (activeTopic === "All") {
      const batch = await fetchRandomBatch(18);
      return pickFirstAcceptable(batch);
    }

    // Map simple topics to one solid category
    const CAT = {
      Physics:    "Category:Physics",
      Math:       "Category:Mathematics",
      Biology:    "Category:Biology",
      Chemistry:  "Category:Chemistry",
      Astronomy:  "Category:Astronomy",
      History:    "Category:History",
      Philosophy: "Category:Philosophy",
      Engineering:"Category:Engineering"
    }[activeTopic];

    // First try the main category
    let pages = await fetchCategoryBatch(CAT, 40);
    let pick = pickFirstAcceptable(pages);
    if (pick) return pick;

    // Fallback: try a closely related subcategory (just one hop so it stays simple)
    const SUB = {
      Physics: "Category:Physical_sciences",
      Math: "Category:Mathematical_concepts",
      Biology: "Category:Biological_concepts",
      Chemistry: "Category:Chemical_compounds",
      Astronomy: "Category:Astrophysics",
      History: "Category:Historical_events",
      Philosophy: "Category:Ethics",
      Engineering: "Category:Mechanical_engineering"
    }[activeTopic];

    if (SUB) {
      pages = await fetchCategoryBatch(SUB, 40);
      pick = pickFirstAcceptable(pages);
    }
    return pick;
  }

  async function fetchAndShow() {
    moreBtn.disabled = true; moreBtn.textContent = "Loading...";
    try {
      const a = await getOneArticle();
      if (a) renderCard(a);
      else {
        const note = document.createElement("div");
        note.className = "card";
        note.innerHTML = `<div class="content"><p class="extract">Couldn’t find a fresh “${activeTopic}” article right now. Try again.</p></div>`;
        feed.insertBefore(note, feed.firstChild);
      }
    } catch (e) {
      console.error(e);
      alert("Network hiccup. Try again.");
    } finally {
      moreBtn.disabled = false; moreBtn.textContent = "Get another article";
    }
  }

  // wire up
  moreBtn.addEventListener("click", fetchAndShow);
  fetchAndShow(); // initial
  // gentle infinite scroll
  let ticking = false;
  window.addEventListener("scroll", () => {
    if (ticking) return; ticking = true;
    requestAnimationFrame(() => {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 250) fetchAndShow();
      ticking = false;
    });
  });
</script>
